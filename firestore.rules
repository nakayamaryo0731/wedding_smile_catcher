rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // Helper: Check if user is an admin (operator)
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/accounts/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/accounts/$(request.auth.uid)).data.is_admin == true;
    }

    // Helper: Check if user owns the event
    function isEventOwner(eventId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/events/$(eventId)) &&
        get(/databases/$(database)/documents/events/$(eventId)).data.account_id == request.auth.uid;
    }

    // Accounts collection
    // Admins can read all; regular users can only read their own
    // Only admins can create/update other accounts; users can update their own
    match /accounts/{accountId} {
      allow read: if request.auth != null && (isAdmin() || request.auth.uid == accountId);
      allow create: if request.auth != null && request.auth.uid == accountId;
      allow update: if request.auth != null && (isAdmin() || request.auth.uid == accountId);
      allow delete: if false;
    }

    // Events collection
    // Public get (single doc) for ranking UI status check
    // Admins can list all; regular users can list their own
    // Write requires ownership or admin
    match /events/{eventId} {
      allow get: if true;
      allow list: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.account_id == request.auth.uid;
      allow update: if request.auth != null
        && (isAdmin() || resource.data.account_id == request.auth.uid);
      allow delete: if request.auth != null
        && (isAdmin() || resource.data.account_id == request.auth.uid);
    }

    // Users collection (LINE users, not Firebase users)
    // Public read for ranking display
    // Admins can write; event owners can update (for soft delete)
    match /users/{userId} {
      allow read: if true;
      allow create: if false;
      allow update: if request.auth != null &&
        (isAdmin() || isEventOwner(resource.data.event_id));
      allow delete: if request.auth != null && isAdmin();
    }

    // Images collection
    // Public read for ranking display
    // Admins can write; event owners can update (for soft delete)
    match /images/{imageId} {
      allow read: if true;
      allow create: if false;
      allow update: if request.auth != null &&
        (isAdmin() || isEventOwner(resource.data.event_id));
      allow delete: if request.auth != null && isAdmin();
    }
  }
}
