# セキュリティ要件定義

一般公開にあたって満たすべきセキュリティ要件を定義する。

最終更新: 2026-01-26

---

## 1. 取り扱うデータ

| データ種別 | 内容 | 機密度 |
|-----------|------|--------|
| 顧客アカウント | メール、パスワード | 高 |
| ゲスト名前 | フルネーム | 中 |
| ゲスト顔写真 | 笑顔の写真 | **高**（生体情報） |
| LINE User ID | LINE内部ID | 中 |
| スコアデータ | 笑顔スコア、AIコメント | 低 |
| イベント情報 | 日付、名前 | 低 |

**特に注意**: 顔写真は生体情報に該当し、個人情報保護法上の「要配慮個人情報」に近い扱いが求められる。

---

## 2. 認証・認可

### 2.1 顧客アカウント認証

| 項目 | 要件 |
|------|------|
| 認証方式 | Firebase Authentication（メール + パスワード） |
| パスワード要件 | 8文字以上 |
| セッション管理 | Firebase SDK のトークンベース |
| ログアウト | 明示的なログアウト機能 |

### 2.2 管理画面のアクセス制御

| 項目 | 要件 |
|------|------|
| 認可モデル | アカウントベース（自分のイベントのみ操作可能） |
| データ分離 | Firestore Security Rules で強制 |
| 管理者ロール | 初期リリースでは不要（将来的に検討） |

### 2.3 Cloud Functions の認証

| 項目 | 要件 |
|------|------|
| webhook | LINE署名検証（`X-Line-Signature`） |
| scoring | GCP IAM サービスアカウント認証（既存） |
| 管理API（将来） | Firebase Auth トークン検証 |

---

## 3. データ保護

### 3.1 保存時の暗号化

| 対象 | 方式 |
|------|------|
| Firestore | Google管理の暗号化（デフォルト） |
| Cloud Storage | Google管理の暗号化（デフォルト） |
| パスワード | Firebase Auth が自動でハッシュ化 |

### 3.2 通信の暗号化

| 対象 | 方式 |
|------|------|
| フロントエンド | HTTPS（Firebase Hosting デフォルト） |
| Cloud Functions | HTTPS（GCP デフォルト） |
| LINE API | HTTPS |

### 3.3 画像アクセス制御

| 項目 | 現状 | MVP目標 |
|------|------|---------|
| Cloud Storage | 公開アクセス | 署名付きURL（有効期限付き）に変更 |
| ランキング表示 | 直接URL | 署名付きURL or Firebase Storage Rules |

**方針**: 署名付きURL（短い有効期限、例: 1時間）を採用。DevToolsで閲覧可能だが、期限切れ後は無効となる。結婚式写真は参加者同士が見ること前提のため、バックエンドプロキシまでは不要と判断。フロントエンドは定期的にURLをリフレッシュする設計とする。

---

## 4. 個人情報保護

### 4.1 データ最小化

- 収集する個人情報は最小限に留める
  - 顧客: メール、表示名
  - ゲスト: 名前、顔写真、LINE User ID
- 不要なデータは収集しない（住所、電話番号等）

### 4.2 データ保持期間

| データ | 保持期間 | 期間後の処理 |
|--------|---------|-------------|
| 画像（Cloud Storage） | イベント後30日間 | 自動削除 |
| Firestoreメタデータ | イベント後30日間 | 自動削除 |
| 顧客アカウント | アカウント削除まで | 手動削除 |

### 4.3 データ削除権

- 顧客はいつでもアカウントとイベントデータの削除を要求可能
- ゲストは顧客を通じて画像削除を要求可能
- 削除要求への対応期間: 30日以内

### 4.4 第三者提供

- 個人情報を第三者に提供しない
- GCP / LINE APIへの送信は「委託」として扱う
- Vision API / Gemini への画像送信はスコアリング目的のみ

---

## 5. アプリケーションセキュリティ

### 5.1 入力バリデーション

| 入力 | バリデーション |
|------|---------------|
| イベントコード | UUID v4形式のみ許可 |
| ユーザー名 | 文字数制限（1-50文字）、スクリプトインジェクション防止 |
| テキストコマンド | ホワイトリスト方式 |

### 5.2 Firestore Security Rules

- フロントエンドからの書き込みは原則禁止
- 読み取りはイベント参加者に限定（ランキング表示は例外）
- 詳細: `docs/planning/multi-tenant-design.md` のセクション7

### 5.3 環境変数・シークレット管理

| シークレット | 管理方式 |
|-------------|---------|
| LINE_CHANNEL_SECRET | GCP Secret Manager |
| LINE_CHANNEL_ACCESS_TOKEN | GCP Secret Manager |
| Firebase設定 | フロントエンドに公開（Firebaseの仕様） |

---

## 6. 運用セキュリティ

### 6.1 ログ・監視

| 項目 | 方式 |
|------|------|
| アプリケーションログ | Cloud Logging |
| エラーアラート | Cloud Monitoring → メール通知 |
| 不正アクセス検知 | Cloud Armor（将来的に検討） |

### 6.2 インシデント対応

| レベル | 例 | 対応 |
|--------|-----|------|
| 低 | スコアリングエラー | ログ確認、再処理 |
| 中 | API障害（部分） | フォールバック自動適用（`scoring.md` 参照）、ログ監視 |
| 高 | API障害（全面停止） | 顧客通知、復旧対応 |
| 高 | データ漏洩の疑い | サービス停止、調査、顧客通知 |

---

## 7. MVPで対応するもの / しないもの

| 要件 | MVP | 理由 |
|------|-----|------|
| Firebase Auth 導入 | ✅ | 必須 |
| Firestore Security Rules 強化 | ✅ | 必須 |
| 利用規約・プライバシーポリシー | ✅ | 必須 |
| 画像の署名付きURL | ✅ | 顔写真の保護 |
| Cloud Monitoring アラート | ✅ | 運用に必須 |
| 入力バリデーション強化 | ✅ | 基本的なセキュリティ |
| WAF（Cloud Armor） | ❌ | コスト見合い、将来検討 |
| SOC2 / ISO27001 | ❌ | 個人開発では不要 |
| ペネトレーションテスト | ❌ | コスト見合い、将来検討 |
