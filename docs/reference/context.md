# プロジェクトコンテキスト

このドキュメントは、プロジェクトの背景、参考資料、技術選定の経緯をまとめたものです。

## プロジェクト概要

**プロジェクト名**: Wedding Smile Catcher
**目的**: 結婚式で参加者から笑顔の写真を集め、AIでスコアリング＆ランキングするLINE Botシステム
**開始日**: 2025-11-18

## 参考資料

### 元となったシステム

- **文献**: エムスリーテックブック8 第2章「結婚式スマイル集める君」
- **著者**: 中村伊吹（エムスリー AI・機械学習チーム）
- **PDFファイル**: `~/Documents/wedding/m3techbook-8-2.pdf`
- **実施日**: 2025年3月（著者の結婚式）

### 元システムの概要

著者が自身の結婚式のために開発したLINE Botシステム。参加者が写真を投稿すると、AIが笑顔を検出・採点し、ランキング形式で式中に発表する仕組み。

#### 結婚式のテーマ

**「笑顔（Smile For You）」**

背景：著者の両親が「よく笑うようになった」と感じ始めた時期が、現在の妻と交際を開始した時期と重なっていた。ウェディングプランナーから「新婦様が新郎様を笑顔にしたのですね」という解釈を受け、結婚式のテーマが「笑顔」に決定。

#### 解決したかった課題

1. **写真共有の問題**: 結婚式で撮られた写真が新郎新婦に共有されるのはほんの一部
2. **高齢者の撮影習慣**: ご高齢の方は写真を撮る習慣があまりない
3. **既存サービスの課題**: Google PhotoやWeddingShareは不慣れな方には使いづらい
4. **アップロード忘れ**: 式後は忙しく、写真をアップロードし忘れる

#### モチベーション設計

単に写真を集めるだけでなく、**ゲーミフィケーション**により参加者が積極的に写真をアップロードしたくなる仕組みを導入。

## 元システムの技術構成（AWS版）

### アーキテクチャ

```
参列者 → LINE Bot → Lambda (LINE API) → Rekognition / Bedrock
                                      ↓
                                  DynamoDB ← Lambda (Backend API)
                                      ↓
                            CloudFront + S3 (Next.js Frontend)
                                      ↓
                                 式場スクリーン
```

### 使用技術（AWS版）

| カテゴリ | サービス/技術 |
|---------|-------------|
| LINE Bot | LINE Messaging API |
| サーバーレス | AWS Lambda (Rust) |
| 画像ストレージ | Amazon S3 |
| データベース | Amazon DynamoDB |
| 顔検出・笑顔検出 | Amazon Rekognition |
| 生成AI | Amazon Bedrock (Nova) |
| フロントエンド | Next.js |
| CDN | CloudFront |
| インフラ管理 | Terraform |

### 元システムの実装言語

- **バックエンド (LINE API, Backend API)**: Rust
- **フロントエンド**: Next.js (TypeScript)

### 元システムの結果

- **参加者の利用率**: 約60%
- **収集した写真**: 368枚
- **同時投稿ピーク**: 50人程度
- **システム稼働**: 式中に一度も問題なく安定稼働

## 核心的な機能

### 1. スコアリングシステム

#### 笑顔スコア（メインスコア）

- Amazon Rekognition（Cloud Vision API）で顔検出
- 各顔の笑顔信頼度（0-100%）を取得
- **全員の笑顔スコアを合計**（例: 5人なら最大500点）
- 狙い: **人数が多いほど高スコア** → グループ間交流を促進

#### テーマ評価（AI評価）

- Amazon Bedrock Nova（Vertex AI Gemini）で画像を評価
- プロンプトで「結婚式の笑顔写真」としての評価を依頼
- 0-100点で評価
- **重要**: OpenAI GPT-4oは「人間に忖度」して無関係な画像にも70点以上つける傾向
- **推奨**: Amazon NovaやGeminiは無関係な画像に0点をつける

#### 総合スコア計算式

```
総合スコア = (笑顔スコア × AI評価 ÷ 100) × 類似ペナルティ
```

### 2. 類似画像検出（Average Hash）

#### 目的

連写された写真や類似構図の写真が大量投稿されるのを防ぐ。多様な写真を収集する。

#### アルゴリズム

1. 画像をグレースケール化
2. 8×8ピクセルにリサイズ
3. 平均輝度を計算
4. 各ピクセルを平均より明るいなら1、暗いなら0に2値化
5. 64bitハッシュ値を生成
6. ハミング距離で類似判定（閾値: 8以下なら類似）

#### ペナルティ

類似画像と判定された場合、**スコアを1/3に減点**。

### 3. LINE Botの挙動

#### ユーザー登録フロー

1. LINE Bot友達追加
2. 最初にユーザー名（フルネーム）をテキストで送信
3. ユーザーIDと名前を紐付け
4. 以降、写真を投稿

#### レスポンス

- 写真投稿直後: **ローディングアニメーション**を表示（UX向上）
- AI処理完了後: スコアとコメントを返信

理由: 生成AIは即座に応答できないため、ローディング表示で「処理中」を伝える。

### 4. 式中の演出

#### リアルタイムモード（披露宴後半）

- 司会者が「5分間、一斉に写真を撮影して投稿しましょう！」とアナウンス
- スクリーンに投稿された写真とスコアをリアルタイム表示
- **更新頻度**: 5秒に1回、APIを呼び出して画面更新
- スコアリングの詳細はブラックボックス → 参加者が「どうすれば高スコア？」と推測・試行錯誤
- 結果: 参加者同士の交流が生まれ、会場が一体となって盛り上がる

#### ランキング結果発表モード

- リアルタイムモード終了後、最終順位を発表
- **重要なルール**: 同じ人は1つの順位にしか入賞できない
  - 理由: 特定の人が全順位を独占するのを防ぐ
  - 実装: トップ100枚からユーザー重複を排除してTop 3を選出

### 5. 受付時の説明

- Canvaでデザインした説明書を受付で配布
- 内容: LINE Bot友達追加QRコード、使い方、スコアを高くするコツ
- 狙い: 待合室の段階から参加者が使い始める

## このプロジェクト（GCP版）の技術選定

### AWS → GCP マッピング

| 機能 | AWS（元システム） | GCP（本プロジェクト） | 備考 |
|------|------------------|---------------------|------|
| 笑顔検出 | Amazon Rekognition | **Cloud Vision API** | 同等の顔検出・感情分析 |
| 生成AI | Amazon Bedrock/Nova | **Vertex AI (Gemini)** | Gemini 1.5で画像解析 |
| サーバーレス | Lambda | **Cloud Functions / Cloud Run** | Cloud Runの方が柔軟 |
| データベース | DynamoDB | **Firestore** | リアルタイム更新が標準 |
| ストレージ | S3 | **Cloud Storage** | 同等 |
| CDN | CloudFront | **Cloud CDN** | 同等 |
| IaC | Terraform | **Terraform** | そのまま使用可能 |
| 類似画像検出 | Average Hash（自前） | **Average Hash（自前）** | クラウド非依存 |

### GCPを選んだ理由

- **開発者の慣れ**: 「私はGoogleの方が得意」（ユーザーの要望）
- **完全な実装可能性**: AWSでしか実現できない機能はない
- **メリット**:
  - Cloud Vision API: 使いやすい、日本語ドキュメント充実
  - Firestore: リアルタイム同期が標準（ランキング表示に便利）
  - Vertex AI: Geminiの画像理解能力が高い
  - 無料枠: 小規模利用なら充実

### 実装言語の選定

**未定** - 元システムはRustだが、このプロジェクトではPythonまたはNode.jsを検討中。

理由:
- Cloud FunctionsはPython/Node.jsの方が情報が多い
- 画像処理ライブラリ（Pillow等）が充実

## 重要な設計思想

### 1. 人々の交流を促進

- 大人数で写るほど高スコア → 他のグループとも一緒に撮影
- 結果: 初対面同士でも「一緒に撮りましょう」と声をかけ合う

### 2. 多様な写真を収集

- 類似画像にペナルティ → 同じ構図ばかりにならない
- 様々なシーン・場面の写真が集まる

### 3. ゲーミフィケーション

- スコアリングアルゴリズムの詳細は非公開
- 参加者が「どうすれば高スコア？」と推測・試行錯誤
- 楽しみながら写真を投稿

### 4. UXへのこだわり

- ローディングアニメーション: 「処理中」が伝わる
- LINE Bot: 誰でも使える親しみやすさ
- 受付での説明書: 不慣れな方へのサポート

### 5. 本番環境での安定性

- 結婚式は**一度きり**のイベント
- サーバーレスアーキテクチャで自動スケーリング
- 式の裏側でMacBookを用意してモニタリング（結果的に不要だった）

## 開発時の教訓（元システムより）

### 良かった点

- システムがダウンしなかった
- 参加者が心から楽しんでくれた
- 60%の参加者が利用、368枚の写真を収集
- LINE Botは参加ハードルが低い

### 難しかった点

#### 1. スコアリングアルゴリズムの調整

- 人数が多いほど有利なアルゴリズム → 俯瞰写真が高スコアになりがち
- 改善案: 顔のサイズもスコアに加味すれば、もっと笑顔の画像が集まったかも

#### 2. 本番調整の難しさ

- 結婚式という**一度きりの舞台**でぶっつけ本番
- アルゴリズムを事前に十分テストすべき

#### 3. 後日のヒヤリ事例

- 披露宴後、DynamoDBのデータの一部がNoneに
- unwrap()で処理が失敗 → API がクラッシュ
- もし披露宴中だったら、ランキング発表ができなかった可能性
- 教訓: エラーハンドリングは徹底すべき

## プロジェクトの目標

本プロジェクト（GCP版）では、元システムの良い点を引き継ぎつつ、以下を目指す：

1. **GCPでの完全な再実装**
2. **ドキュメントの充実** - 設計・実装を丁寧に記録
3. **再利用可能な構成** - 他の結婚式でも使えるように
4. **エラーハンドリングの強化** - 本番での安定性向上
5. **コスト最適化** - 無料枠を活用

## 次のステップ

このコンテキストを踏まえて、以下のドキュメントを作成中：

- [x] README.md
- [x] アーキテクチャ概要 (docs/architecture/overview.md)
- [x] スコアリングアルゴリズム (docs/architecture/scoring.md)
- [ ] データベース設計 (docs/architecture/database.md)
- [ ] GCP技術選定詳細
- [ ] LINE Bot設計仕様
- [ ] API仕様書
- [ ] セットアップガイド

---

**最終更新**: 2025-11-18
**参照PDF**: ~/Documents/wedding/m3techbook-8-2.pdf
**プロジェクトパス**: ~/Dev/wedding_smile_catcher
