# 結婚式当日の運用ガイド

**目的**: 結婚式当日の準備から後処理までの完全なチェックリスト

---

## 📅 タイムライン概要

```
1週間前        前日          当日（式前）      当日（式中）      当日（式後）      1週間後
   │             │                │                 │                 │              │
   │本番準備     │最終確認        │システム起動    │モニタリング    │一次確認      │データ納品
   │             │                │                 │                 │              │
   ▼             ▼                ▼                 ▼                 ▼              ▼
```

---

## 🗓️ 1週間前：本番準備

### やること

結婚式本番用のイベントを作成し、システムを本番モードに切り替える

### 手順

#### ステップ1: 本番イベントの作成（所要時間: 5分）

```bash
# ターミナルを開く
cd ~/Dev/wedding_smile_catcher

# 本番イベントを作成
python scripts/create_event.py \
  --event-id="wedding_20250315_tanaka" \
  --event-name="田中太郎 & 花子 結婚式" \
  --event-date="2025-03-15" \
  --status="active"
```

**確認事項**:

- ✅ イベントIDが正しい（日付と名前）
- ✅ イベント名が正しい
- ✅ ステータスが `active`

---

#### ステップ2: システムを本番モードに切り替え（所要時間: 10-15分）

```bash
# イベントを切り替え（Cloud Functions + Frontend自動更新）
./scripts/switch_event.sh wedding_20250315_tanaka
```

**このスクリプトが自動実行すること**:

1. Cloud Functions（webhook, scoring）の環境変数を更新
2. Frontendを再ビルド＆Firebase Hostingにデプロイ
3. イベント統計を表示

**確認事項**:

- ✅ スクリプトがエラーなく完了した
- ✅ 統計が表示され、ユーザー0人、画像0枚であることを確認

---

#### ステップ3: 動作確認（所要時間: 10分）

**3-1. LINEボットでテスト投稿**

1. LINEアプリでボットを開く
2. テキストメッセージで名前を送信（例: 「テスト太郎」）
3. 画像を1枚投稿
4. スコアが返信されることを確認

**3-2. Firestoreで確認**

```bash
# イベントの統計を確認
python scripts/event_stats.py wedding_20250315_tanaka
```

**期待する出力**:

```
👥 ユーザー数: 1人
📸 投稿画像数: 1枚
```

**3-3. Frontendで確認**

1. ブラウザで `https://wedding-smile-catcher.web.app` を開く
2. テスト画像がランキングに表示されることを確認

**確認事項**:

- ✅ LINEボットが正常に動作
- ✅ スコアが返信される
- ✅ Frontendにランキングが表示される
- ✅ テストデータ（`event_id=test`）が表示されていない

---

#### ステップ4: テストデータの削除（所要時間: 3分）

```bash
# Firestoreコンソールでテストユーザーを手動削除
# または、テストユーザーのevent_idをtestに戻す

# 統計で確認
python scripts/event_stats.py wedding_20250315_tanaka
# → ユーザー数: 0人、画像数: 0枚 を確認
```

**重要**: 本番前にクリーンな状態にする

---

#### ステップ5: 受付用QRコードの準備（所要時間: 15分）

**5-1. LINE Bot QRコードを取得**

1. LINE Developers コンソールにログイン
2. チャネル設定 → QRコードをダウンロード

**5-2. 説明書を作成（Canva推奨）**

受付で配布する説明書に以下を記載：

```
┌─────────────────────────────────────┐
│  Wedding Smile Catcher 使い方       │
├─────────────────────────────────────┤
│                                     │
│  ①LINEボットを友だち追加            │
│    [QRコード]                       │
│                                     │
│  ②お名前（フルネーム）を送信        │
│    例: 山田太郎                     │
│                                     │
│  ③笑顔の写真を送信！                │
│    みんなで撮ると高スコア♪          │
│                                     │
│  ④スクリーンでリアルタイム表示      │
│                                     │
└─────────────────────────────────────┘
```

**5-3. 印刷**

- A5サイズで50-100部印刷
- 受付に配置

---

### チェックリスト（1週間前）

- [ ] 本番イベントを作成した
- [ ] システムを本番モードに切り替えた
- [ ] LINEボットで動作確認した
- [ ] Frontendで表示確認した
- [ ] テストデータを削除した（本番イベントがクリーン）
- [ ] 受付用QRコードを準備した
- [ ] 説明書を印刷した

---

## 🕐 前日：最終確認

### やること

システムが正常に動作していることを確認し、バックアップを取得

### 手順

#### ステップ1: システム稼働確認（所要時間: 5分）

```bash
# 現在のイベントIDを確認
gcloud functions describe webhook \
  --format="value(environmentVariables.CURRENT_EVENT_ID)"

# 期待: wedding_20250315_tanaka
```

**確認事項**:

- ✅ 環境変数が本番イベントID
- ✅ `test` になっていない

---

#### ステップ2: データ確認（所要時間: 3分）

```bash
# 統計確認
python scripts/event_stats.py wedding_20250315_tanaka

# 期待:
# ユーザー数: 0人
# 画像数: 0枚
```

**もし誤ってデータが入っている場合**:

- Firestoreコンソールで手動削除
- または管理者に連絡

---

#### ステップ3: バックアップ（所要時間: 5分）

```bash
# Firestoreをエクスポート（念のため）
gcloud firestore export gs://wedding-backup/pre-wedding-$(date +%Y%m%d)
```

**確認事項**:

- ✅ エクスポートが成功
- ✅ Cloud Storageにバックアップファイルが存在

---

#### ステップ4: 緊急連絡先の確認

**万が一トラブルが起きた場合の連絡先**:

- GCPコンソール: <https://console.cloud.google.com>
- Firebase コンソール: <https://console.firebase.google.com>
- LINE Developers: <https://developers.line.biz>

**緊急時の対応者**:

- 自分（システム管理者）
- バックアップ担当者（いれば）

---

### チェックリスト（前日）

- [ ] 環境変数が本番イベントIDであることを確認
- [ ] データがクリーンな状態（0件）であることを確認
- [ ] Firestoreバックアップを取得
- [ ] 緊急連絡先を確認
- [ ] 説明書を持参することを確認

---

## 🎊 当日（式開始3時間前）：システム起動

### やること

会場でシステムをセットアップし、最終動作確認

### 手順

#### ステップ1: 会場到着・機材セットアップ（所要時間: 30分）

**必要な機材**:

- ノートPC（モニタリング用）
- スクリーン接続用のPC/タブレット（ランキング表示用）
- Wi-Fi接続確認

**セットアップ**:

1. ノートPCを開き、インターネット接続確認
2. スクリーン用PCでFrontendを開く
   - URL: `https://wedding-smile-catcher.web.app`
3. フルスクリーンモード（F11）

---

#### ステップ2: 最終動作確認（所要時間: 10分）

**2-1. テスト投稿**

1. 自分のスマホでLINEボットにアクセス
2. 名前を送信（例: 「システムテスト」）
3. 画像を1枚投稿
4. スコアが返信されることを確認
5. スクリーンに表示されることを確認

**2-2. データ削除**

```bash
# Firestoreコンソールでテストユーザーを削除
# または、後で削除でもOK（event_idが同じなので問題ない）
```

---

#### ステップ3: システム監視準備（所要時間: 5分）

**ノートPCでモニタリング画面を開く**:

1. ターミナルを開く
2. 統計表示スクリプトを実行準備

```bash
cd ~/Dev/wedding_smile_catcher

# 統計を表示（随時実行）
python scripts/event_stats.py wedding_20250315_tanaka
```

3. Cloud Loggingコンソールを開く
   - URL: <https://console.cloud.google.com/logs>
   - フィルタ: `resource.type="cloud_function"`

**確認事項**:

- ✅ エラーログがない
- ✅ 正常に動作している

---

### チェックリスト（当日・式前）

- [ ] 会場でWi-Fi接続確認
- [ ] スクリーンにFrontendを表示
- [ ] テスト投稿で動作確認
- [ ] スクリーンに表示されることを確認
- [ ] モニタリング画面を準備
- [ ] 受付に説明書を配置

---

## 🎉 当日（式中）：リアルタイム運用

### やること

システムを監視し、トラブルに対応

### 基本方針

**基本的には何もしない**

- システムは自動で動作
- 参列者が写真を投稿すると自動でスコアリング
- ランキングは自動更新（1分ごとにポーリング）

**やること**:

- 定期的に統計確認（15分ごと）
- エラーログ確認（必要に応じて）
- トラブル対応（必要な場合のみ）

---

### 定期確認（15分ごと）

```bash
# 統計表示
python scripts/event_stats.py wedding_20250315_tanaka
```

**確認事項**:

- ✅ 投稿数が増えているか
- ✅ スコアが正常に計算されているか
- ✅ ランキングが表示されているか

---

### トラブルシューティング

#### ケース1: スコアが返信されない

**原因**: Scoring Functionのエラー

**対処**:

1. Cloud Loggingでエラー確認

   ```
   resource.type="cloud_function"
   resource.labels.function_name="scoring"
   severity>=ERROR
   ```

2. エラー内容を確認
3. 一時的な問題なら待機
4. 継続的なエラーなら再デプロイ

---

#### ケース2: ランキングが表示されない

**原因**: Frontend/Firestoreの問題

**対処**:

1. ブラウザをリロード（F5）
2. Firestoreコンソールでデータ確認
3. Frontendログ確認（ブラウザのDevTools）

---

#### ケース3: 誤ってテストイベントで投稿された

**対処**:

```bash
# 急いでイベントを切り替え
./scripts/switch_event.sh wedding_20250315_tanaka

# データマイグレーション（後で実施）
# 式中は放置してOK、式後に対処
```

---

### チェックリスト（当日・式中）

- [ ] 15分ごとに統計確認
- [ ] スクリーン表示の確認
- [ ] エラーログ確認（随時）
- [ ] トラブル対応（必要に応じて）

---

## 🌟 当日（式終了後）：一次確認

### やること

データが正常に保存されたことを確認

### 手順

#### ステップ1: 最終統計確認（所要時間: 5分）

```bash
# 統計表示
python scripts/event_stats.py wedding_20250315_tanaka
```

**確認事項**:

- ✅ ユーザー数が期待通り
- ✅ 投稿画像数が期待通り
- ✅ トップ3が表示される

**記録**:

- ユーザー数: ______人
- 投稿画像数: ______枚
- 最高スコア: ______点

---

#### ステップ2: 一時バックアップ（所要時間: 5分）

```bash
# Firestoreをエクスポート
gcloud firestore export gs://wedding-backup/post-wedding-$(date +%Y%m%d)
```

**確認事項**:

- ✅ エクスポートが成功
- ✅ データが消失していない

---

#### ステップ3: スクリーンショット保存

**ランキング画面をスクリーンショット**:

- トップ3の画面
- 統計画面
- 記念に保存

---

### チェックリスト（当日・式後）

- [ ] 最終統計を確認
- [ ] データ件数を記録
- [ ] Firestoreバックアップ取得
- [ ] ランキング画面をスクリーンショット
- [ ] データが消失していないことを確認

---

## 📦 1週間後：データ納品

### やること

全データをダウンロードし、新郎新婦に納品

### 手順

#### ステップ1: イベントをアーカイブ（所要時間: 3分）

```bash
# イベントをアーカイブ状態に変更
python scripts/archive_event.py wedding_20250315_tanaka
```

**確認事項**:

- ✅ イベントステータスが `archived` に変更

---

#### ステップ2: 全データをダウンロード（所要時間: 10-30分）

```bash
# 全画像とメタデータをダウンロード
./scripts/download_event_images.sh wedding_20250315_tanaka
```

**このスクリプトが実行すること**:

1. Cloud Storageから全画像をダウンロード
2. Firestoreのメタデータ（ユーザー、スコア情報）をJSON出力
3. ダウンロード統計を表示

**保存先**: `./downloads/wedding_20250315_tanaka/`

**確認事項**:

- ✅ 画像が全てダウンロードされた
- ✅ JSONファイルが作成された

---

#### ステップ3: ZIPアーカイブ作成（所要時間: 5分）

```bash
# ダウンロードディレクトリに移動
cd downloads

# ZIPアーカイブを作成
zip -r wedding_20250315_tanaka_all_data.zip \
  wedding_20250315_tanaka \
  wedding_20250315_tanaka_data.json
```

**確認事項**:

- ✅ ZIPファイルが作成された
- ✅ ファイルサイズが妥当（数百MB〜数GB）

---

#### ステップ4: 納品（所要時間: 30分）

**納品方法（いずれか）**:

**オプション1: Google Drive**

1. Google Driveにアップロード
2. 新郎新婦と共有

**オプション2: USB/外付けHDD**

1. USBメモリにコピー
2. 直接手渡し

**オプション3: クラウドストレージ**

1. Dropbox、OneDriveなどにアップロード
2. ダウンロードリンクを共有

**納品物**:

- `wedding_20250315_tanaka_all_data.zip`
  - 全画像（original/）
  - メタデータ（wedding_20250315_tanaka_data.json）

**JSONファイルの中身**:

```json
{
  "event": { "event_name": "田中太郎 & 花子 結婚式", ... },
  "users": [ { "name": "山田太郎", ... }, ... ],
  "images": [
    {
      "image_id": "...",
      "total_score": 389.3,
      "smile_score": 458.0,
      "ai_score": 85,
      "comment": "素晴らしい笑顔です！",
      ...
    },
    ...
  ]
}
```

---

#### ステップ5: システムをテストモードに戻す（所要時間: 10分）

```bash
# テストイベントに切り替え
./scripts/switch_event.sh test
```

**確認事項**:

- ✅ 環境変数が `test` に戻った
- ✅ 次の結婚式に備えて準備完了

---

### チェックリスト（1週間後）

- [ ] イベントをアーカイブした
- [ ] 全データをダウンロードした
- [ ] ZIPアーカイブを作成した
- [ ] 新郎新婦に納品した
- [ ] システムをテストモードに戻した

---

## 🎯 重要な注意事項

### データの保持

**Cloud Storageの画像は削除しない！**

- イベント終了後も永続的に保持
- 必要に応じていつでもダウンロード可能
- 90日後にARCHIVEストレージクラスに自動移行（コスト削減）

**理由**:

- 新郎新婦が後で追加ダウンロードを依頼する可能性
- 式場やプランナーがデータを欲しがる可能性
- バックアップとして保持

---

### 緊急時の連絡先

**システムトラブル時**:

- GCPコンソール: <https://console.cloud.google.com>
- Cloud Logging: エラーログ確認
- Firebase コンソール: Frontend確認

**重大なトラブル（システムダウン）**:

1. 落ち着く
2. Cloud Loggingでエラー確認
3. 一時的な問題なら待機（5-10分）
4. 継続的なエラーならCloud Functions再デプロイ

**最悪の場合**:

- 紙とペンで写真収集（アナログフォールバック）
- 式後にLINEグループで共有依頼

---

## 📊 参考：想定タイムライン（当日）

```
10:00  会場到着、セットアップ開始
10:30  システム最終確認、テスト投稿
11:00  受付開始、説明書配布
12:00  挙式開始
13:00  披露宴開始
13:30  写真投稿開始（ゲスト）
14:00  統計確認（15分ごと）
15:00  リアルタイムモード開始（司会アナウンス）
15:05  一斉投稿タイム（5分間）
15:10  ランキング発表
16:00  披露宴終了
16:30  最終統計確認、バックアップ取得
```

---

## 🎓 トレーニング

**本番前に練習しておくこと**:

1. **イベント作成・切り替え**

   ```bash
   python scripts/create_event.py --event-id=test_practice ...
   ./scripts/switch_event.sh test_practice
   ```

2. **テスト投稿**
   - 自分のスマホで何度か投稿
   - スコア計算を確認
   - ランキング表示を確認

3. **統計表示**

   ```bash
   python scripts/event_stats.py test_practice
   ```

4. **データダウンロード**

   ```bash
   ./scripts/download_event_images.sh test_practice
   ```

**目標**: スクリプトを見ずに操作できるようになる

---

**最終更新**: 2025-01-23
